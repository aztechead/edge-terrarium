# =============================================================================
# VAULT INITIALIZATION JOB FOR K3S
# =============================================================================
# This job initializes Vault with the required secrets for K3s
#
# Key Concepts:
# - Job: Runs a task to completion (one-time execution)
# - Init Container: Runs before main application containers start
# - Vault KV Store: Key-value storage for secrets
# - Base64 Encoding: Encodes binary data for storage
# - Conditional Logic: Handles missing certificates gracefully
#
# Impact:
# - Automatically populates Vault with required secrets
# - Ensures Custom client can retrieve secrets on startup
# - Handles both real and mock TLS certificates
# - Runs once and completes successfully
# - Provides consistent secrets between Docker Compose and K3s
#
# Documentation: https://kubernetes.io/docs/concepts/workloads/controllers/job/
# =============================================================================

apiVersion: batch/v1                   # Batch API version for Job resources
kind: Job                              # Resource type - creates a job
metadata:                              # Metadata about this job
  name: vault-init                    # Name of the job
  namespace: edge-terrarium           # Namespace where this job lives
  labels:                             # Labels for organization and selection
    app: vault-init                   # Identifies this as a Vault initialization job
    project: edge-terrarium           # Identifies this as part of the edge-terrarium project
    environment: development          # Identifies this as a development environment
spec:                                  # Specification for the job
  template:                           # Pod template for the job
    metadata:                         # Metadata for pods created from this template
      labels:                         # Labels applied to each pod
        app: vault-init               # Must match the selector
        project: edge-terrarium       # Identifies this as part of the edge-terrarium project
        environment: development      # Identifies this as a development environment
    spec:                             # Specification for pods
      restartPolicy: OnFailure        # Restart pod if it fails (but not if it succeeds)
      containers:                     # List of containers in the pod
      - name: vault-init             # Name of the container
        image: alpine:3.18           # Lightweight Alpine image with curl
        command: ['sh', '-c']        # Override the default entrypoint
        args:                        # Arguments for the command
          - |                        # Multi-line script
            set -e  # Exit on any error
            
            echo "Installing required packages..."
            apk add --no-cache curl bash
            
            echo "Vault initialization starting..."
            echo "VAULT_ADDR: http://vault.edge-terrarium.svc.cluster.local:8200"
            echo "VAULT_TOKEN: root"
            
            # Wait for Vault to be ready before proceeding
            echo "Waiting for Vault to be ready..."
            for i in {1..30}; do
              if curl -s http://vault.edge-terrarium.svc.cluster.local:8200/v1/sys/health >/dev/null 2>&1; then
                echo "Vault is ready!"
                break
              fi
              echo "Vault is not ready yet. Waiting... (attempt $i/30)"
              sleep 2
            done
            
            # Check if Vault is actually ready
            if ! curl -s http://vault.edge-terrarium.svc.cluster.local:8200/v1/sys/health >/dev/null 2>&1; then
              echo "ERROR: Vault is not ready after 60 seconds"
              exit 1
            fi
            
            echo "Vault is ready. Running enhanced initialization script..."
            
            # Run the enhanced Vault initialization script
            bash /scripts/init-vault-enhanced.sh http://vault.edge-terrarium.svc.cluster.local:8200 both
            
            echo "Vault initialization completed successfully!"
        
        env:                          # Environment variables for the container
        - name: VAULT_ADDR            # Vault API address
          value: "http://vault.edge-terrarium.svc.cluster.local:8200"
        - name: VAULT_TOKEN           # Vault authentication token
          value: "root"
        
        volumeMounts:                 # Mount volumes into the container
        - name: tls-certs             # Mount the TLS certificates secret
          mountPath: /tmp/certs       # Mount point in container
          readOnly: true              # Mount as read-only
        - name: scripts               # Mount the scripts directory
          mountPath: /scripts         # Mount point in container
          readOnly: true              # Mount as read-only
      
      volumes:                        # Volumes available to the pod
      - name: tls-certs               # TLS certificates volume
        secret:                       # Volume from a Kubernetes secret
          secretName: edge-terrarium-tls # Name of the secret
          optional: true              # Don't fail if secret doesn't exist
      - name: scripts                 # Scripts volume
        configMap:                    # Volume from a ConfigMap
          name: vault-init-scripts    # Name of the ConfigMap
          defaultMode: 0755           # Make scripts executable
