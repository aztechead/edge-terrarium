version: '3.8'

services:
{% for app in apps %}
  # {{ app.description }}
  {{ app.name }}:
    {% if app.docker.image_name == 'hashicorp/vault' %}
    image: {{ app.docker.image_name }}:{{ app.docker.tag }}
    {% else %}
    build:
      context: ./apps/{{ app.name }}
      dockerfile: {{ app.docker.dockerfile }}
    {% endif %}
    {% if app.runtime.port_forward %}
    ports:
      - "{{ app.runtime.port_forward }}:{{ app.runtime.port }}"
    {% elif app.name == 'nginx' %}
    ports:
      - "8443:443"
    {% elif app.name == 'vault' %}
    ports:
      - "8200:8200"
    {% endif %}
    {% if app.environment %}
    environment:
      {% for env in app.environment %}
      {% if env.value %}
      - {{ env.name }}={{ env.value }}
      {% elif env.value_from %}
      - {{ env.name }}={{ env.value_from }}
      {% endif %}
      {% endfor %}
    {% endif %}
    {% if app.volumes or app.name == 'nginx' %}
    volumes:
      {% if app.volumes %}
      {% for volume in app.volumes %}
      - {{ volume.name }}:{{ volume.mount_path }}
      {% endfor %}
      {% endif %}
      {% if app.name == 'nginx' %}
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/server.conf:/etc/nginx/conf.d/server.conf:ro
      - ../../certs/edge-terrarium.crt:/etc/nginx/ssl/tls.crt:ro
      - ../../certs/edge-terrarium.key:/etc/nginx/ssl/tls.key:ro
      {% endif %}
    {% endif %}
    {% if app.dependencies %}
    depends_on:
      {% for dep in app.dependencies %}
      - {{ dep }}
      {% endfor %}
    {% elif app.name != 'vault' %}
    depends_on:
      - vault
    {% endif %}
    networks:
      - {{ global_config.network_name }}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:{{ app.runtime.port }}{{ app.runtime.health_check_path }}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

{% endfor %}

volumes:
{% for app in apps %}
  {% for volume in app.volumes %}
  {{ volume.name }}:
  {% endfor %}
{% endfor %}

networks:
  {{ global_config.network_name }}:
    driver: bridge
